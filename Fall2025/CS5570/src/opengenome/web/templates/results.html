{% extends "base.html" %}

{% block title %}OpenGenome2 - Results{% endblock %}

{% block content %}
<div class="card">
    <h2>Analysis Results</h2>
    <p>Browse, preview, and download completed analysis results.</p>
</div>

<div class="card">
    <h3>Available Results</h3>
    <div id="results-loading" class="loading active">
        <div class="spinner"></div>
        <p>Loading results...</p>
    </div>
    <div id="results-content" style="display: none;">
        <table id="results-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Files</th>
                    <th>Size (MB)</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="no-results" style="display: none; text-align: center; padding: 40px; color: #7f8c8d;">
            <p>No results found. Run some analyses first!</p>
            <a href="/analyze"><button style="margin-top: 10px;">Go to Analyze</button></a>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="background: white; margin: 50px auto; padding: 20px; max-width: 900px; max-height: 80vh; overflow: auto; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="preview-title" style="margin: 0;">Preview</h3>
            <button onclick="closePreview()" style="background: #e74c3c;">‚úï Close</button>
        </div>
        <div id="preview-content">
            <div class="loading active">
                <div class="spinner"></div>
                <p>Loading preview...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Load results
    async function loadResults() {
        try {
            const response = await fetch('/api/results');
            const data = await response.json();
            
            if (data.status === 'success') {
                const tbody = document.querySelector('#results-table tbody');
                tbody.innerHTML = '';
                
                if (data.results.length === 0) {
                    document.getElementById('no-results').style.display = 'block';
                    document.getElementById('results-table').style.display = 'none';
                } else {
                    data.results.forEach(result => {
                        const row = tbody.insertRow();
                        const date = new Date(result.modified);
                        row.innerHTML = `
                            <td><strong>${result.name}</strong></td>
                            <td>${result.file_count}</td>
                            <td>${result.size_mb.toFixed(2)}</td>
                            <td>${date.toLocaleString()}</td>
                            <td>
                                <button onclick="previewResult('${result.name}')" style="margin-right: 5px; padding: 5px 10px; font-size: 12px;">üëÅ Preview</button>
                                <button onclick="downloadResult('${result.name}')" style="padding: 5px 10px; font-size: 12px; background: #27ae60;">‚¨á Download</button>
                            </td>
                        `;
                    });
                }
                
                document.getElementById('results-loading').style.display = 'none';
                document.getElementById('results-content').style.display = 'block';
            }
        } catch (error) {
            document.getElementById('results-loading').innerHTML = '<p style="color: #e74c3c;">Failed to load results</p>';
        }
    }
    
    async function previewResult(name) {
        document.getElementById('preview-modal').style.display = 'block';
        document.getElementById('preview-title').textContent = `Preview: ${name}`;
        document.getElementById('preview-content').innerHTML = '<div class="loading active"><div class="spinner"></div><p>Loading preview...</p></div>';
        
        try {
            const response = await fetch(`/api/results/${name}/preview`);
            const data = await response.json();
            
            if (data.status === 'success') {
                let html = `<p><strong>Total rows:</strong> ${data.total_rows.toLocaleString()}</p>`;
                html += `<p><strong>Showing:</strong> First ${data.preview.length} rows</p>`;
                
                if (data.columns && data.preview.length > 0) {
                    html += '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 13px;">';
                    html += '<thead><tr>';
                    data.columns.forEach(col => {
                        html += `<th style="padding: 8px; background: #f8f9fa; border: 1px solid #dee2e6;">${col}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    data.preview.forEach(row => {
                        html += '<tr>';
                        data.columns.forEach(col => {
                            let val = row[col];
                            // Truncate long strings
                            if (typeof val === 'string' && val.length > 50) {
                                val = val.substring(0, 47) + '...';
                            }
                            html += `<td style="padding: 6px; border: 1px solid #dee2e6; font-family: monospace;">${val !== null ? val : '-'}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }
                
                document.getElementById('preview-content').innerHTML = html;
            } else {
                document.getElementById('preview-content').innerHTML = `<p style="color: #e74c3c;">Error: ${data.message}</p>`;
            }
        } catch (error) {
            document.getElementById('preview-content').innerHTML = `<p style="color: #e74c3c;">Failed to load preview: ${error.message}</p>`;
        }
    }
    
    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
    }
    
    async function downloadResult(name) {
        showAlert(`Preparing download for ${name}...`, 'info');
        window.location.href = `/api/results/${name}/download`;
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePreview();
    });
    
    // Close modal on background click
    document.getElementById('preview-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('preview-modal')) closePreview();
    });
    
    loadResults();
</script>
{% endblock %}
