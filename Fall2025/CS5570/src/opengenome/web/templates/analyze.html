{% extends "base.html" %}

{% block title %}OpenGenome2 - Analyze{% endblock %}

{% block content %}
<div class="card">
    <h2>Sequence Analysis</h2>
    <p>Run k-mer or codon usage analysis on your Parquet datasets.</p>
</div>

<div class="card">
    <h3>Available Datasets</h3>
    <div id="datasets-loading" class="loading active">
        <div class="spinner"></div>
        <p>Loading datasets...</p>
    </div>
    <div id="datasets-content" style="display: none;">
        <table id="datasets-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Path</th>
                    <th>Shards</th>
                    <th>Size (MB)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="card">
    <h3>K-mer Analysis</h3>
    <form id="kmer-form">
        <div class="form-group">
            <label for="kmer-input">Input Dataset Path</label>
            <input type="text" id="kmer-input" name="input" placeholder="/data/parquet/organelle" required>
            <div class="help-text">Select from available datasets above</div>
        </div>
        
        <div class="form-group">
            <label for="kmer-output">Output Path</label>
            <input type="text" id="kmer-output" name="output" value="/results/kmer" placeholder="/results/kmer">
        </div>
        
        <div class="form-group">
            <label for="kmer-k">K-mer Size (k)</label>
            <input type="number" id="kmer-k" name="k" value="5" min="1" max="15">
        </div>
        
        <div class="form-group">
            <label for="kmer-min-count">Minimum Count</label>
            <input type="number" id="kmer-min-count" name="min_count" value="1" min="1">
        </div>
        
        <div class="form-group">
            <label for="kmer-top">Top N Results (optional)</label>
            <input type="number" id="kmer-top" name="top" placeholder="Leave empty for all">
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="kmer-skip-n" name="skip_n" value="true" checked>
                Skip k-mers containing N
            </label>
        </div>
        
        <button type="submit">Run K-mer Analysis</button>
    </form>
    
    <div id="kmer-loading" class="loading">
        <div class="spinner"></div>
        <p>Running k-mer analysis...</p>
    </div>
    
    <div id="kmer-result" style="display: none; margin-top: 20px;">
        <div class="alert alert-success">Analysis completed!</div>
        <p>Output: <code id="kmer-output-path">-</code></p>
    </div>
</div>

<div class="card">
    <h3>Codon Usage Analysis</h3>
    <form id="codon-form">
        <div class="form-group">
            <label for="codon-input">Input Dataset Path</label>
            <input type="text" id="codon-input" name="input" placeholder="/data/parquet/organelle" required>
        </div>
        
        <div class="form-group">
            <label for="codon-output">Output Path</label>
            <input type="text" id="codon-output" name="output" value="/results/codon" placeholder="/results/codon">
        </div>
        
        <div class="form-group">
            <label for="codon-frame">Reading Frame</label>
            <select id="codon-frame" name="frame">
                <option value="0" selected>Frame 0</option>
                <option value="1">Frame 1</option>
                <option value="2">Frame 2</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="codon-min-count">Minimum Count</label>
            <input type="number" id="codon-min-count" name="min_count" value="1" min="1">
        </div>
        
        <div class="form-group">
            <label for="codon-top">Top N Results (optional)</label>
            <input type="number" id="codon-top" name="top" placeholder="Leave empty for all">
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="codon-skip-n" name="skip_n" value="true" checked>
                Skip codons containing N
            </label>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="codon-skip-stops" name="skip_stops" value="true">
                Skip stop codons
            </label>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="codon-rscu" name="rscu" value="true">
                Calculate RSCU (Relative Synonymous Codon Usage)
            </label>
        </div>
        
        <button type="submit">Run Codon Analysis</button>
    </form>
    
    <div id="codon-loading" class="loading">
        <div class="spinner"></div>
        <p>Running codon usage analysis...</p>
    </div>
    
    <div id="codon-result" style="display: none; margin-top: 20px;">
        <div class="alert alert-success">Analysis completed!</div>
        <p>Output: <code id="codon-output-path">-</code></p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Load available datasets
    async function loadDatasets() {
        try {
            const response = await fetch('/api/datasets');
            const data = await response.json();
            
            if (data.status === 'success') {
                const tbody = document.querySelector('#datasets-table tbody');
                tbody.innerHTML = '';
                
                data.datasets.forEach(ds => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${ds.name}</strong></td>
                        <td><code style="cursor: pointer;" onclick="selectDataset('${ds.path}')">${ds.path}</code></td>
                        <td>${ds.shards}</td>
                        <td>${ds.size_mb.toFixed(2)}</td>
                    `;
                });
                
                document.getElementById('datasets-loading').style.display = 'none';
                document.getElementById('datasets-content').style.display = 'block';
            }
        } catch (error) {
            document.getElementById('datasets-loading').innerHTML = '<p style="color: #e74c3c;">Failed to load datasets</p>';
        }
    }
    
    function selectDataset(path) {
        document.getElementById('kmer-input').value = path;
        document.getElementById('codon-input').value = path;
        showAlert('Dataset path copied to input fields', 'info');
    }
    
    // Handle k-mer form
    document.getElementById('kmer-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            if (value !== '') {
                data[key] = (key === 'skip_n') ? true : value;
            }
        }
        
        const loadingEl = document.getElementById('kmer-loading');
        const resultEl = document.getElementById('kmer-result');
        
        loadingEl.classList.add('active');
        resultEl.style.display = 'none';
        e.target.querySelector('button').disabled = true;
        
        try {
            const response = await fetch('/api/analyze/kmer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            
            if (responseData.status === 'success') {
                document.getElementById('kmer-output-path').textContent = data.output;
                resultEl.style.display = 'block';
                showAlert('K-mer analysis completed!', 'success');
            } else {
                showAlert('Error: ' + responseData.message, 'error');
            }
        } catch (error) {
            showAlert('Request failed: ' + error.message, 'error');
        } finally {
            loadingEl.classList.remove('active');
            e.target.querySelector('button').disabled = false;
        }
    });
    
    // Handle codon form
    document.getElementById('codon-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            if (value !== '') {
                data[key] = (['skip_n', 'skip_stops', 'rscu'].includes(key)) ? true : value;
            }
        }
        
        const loadingEl = document.getElementById('codon-loading');
        const resultEl = document.getElementById('codon-result');
        
        loadingEl.classList.add('active');
        resultEl.style.display = 'none';
        e.target.querySelector('button').disabled = true;
        
        try {
            const response = await fetch('/api/analyze/codon', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            
            if (responseData.status === 'success') {
                document.getElementById('codon-output-path').textContent = data.output;
                resultEl.style.display = 'block';
                showAlert('Codon analysis completed!', 'success');
            } else {
                showAlert('Error: ' + responseData.message, 'error');
            }
        } catch (error) {
            showAlert('Request failed: ' + error.message, 'error');
        } finally {
            loadingEl.classList.remove('active');
            e.target.querySelector('button').disabled = false;
        }
    });
    
    // Load datasets on page load
    loadDatasets();
</script>
{% endblock %}
