{% extends "base.html" %}

{% block title %}OpenGenome2 - Ingest{% endblock %}

{% block content %}
<div class="card">
    <h2>Data Ingestion</h2>
    <p>Convert FASTA files to Parquet format for analysis.</p>
</div>

<div class="card">
    <h3>Upload Local FASTA File</h3>
    <form id="local-ingest-form">
        <div class="form-group">
            <label for="file">FASTA File (gzipped or plain)</label>
            <input type="file" id="file" name="file" accept=".fasta,.fa,.fna,.ffn,.faa,.frn,.gz" required>
            <div class="help-text">Supported formats: .fasta, .fa, .fna, .ffn, .faa, .frn (optionally .gz)</div>
        </div>
        
        <div class="form-group">
            <label for="output">Output Directory</label>
            <input type="text" id="output" name="output" value="/data/parquet/local" placeholder="/data/parquet/local">
        </div>
        
        <div class="form-group">
            <label for="source-name">Source Name</label>
            <input type="text" id="source-name" name="source_name" value="local" placeholder="local">
        </div>
        
        <div class="form-group">
            <label for="chunk-size">Chunk Size (sequences per shard)</label>
            <input type="number" id="chunk-size" name="chunk_size" value="50000" min="1000">
        </div>
        
        <div class="form-group">
            <label for="compression">Compression</label>
            <select id="compression" name="compression">
                <option value="snappy" selected>Snappy</option>
                <option value="gzip">Gzip</option>
                <option value="zstd">Zstd</option>
                <option value="none">None</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="append" name="append" value="true">
                Append to existing shards
            </label>
        </div>
        
        <div class="form-group">
            <label for="max-sequences">Max Sequences (optional, for testing)</label>
            <input type="number" id="max-sequences" name="max_sequences" placeholder="Leave empty for all">
        </div>
        
        <button type="submit">Upload and Ingest</button>
    </form>
    
    <div id="local-loading" class="loading">
        <div class="spinner"></div>
        <p>Processing FASTA file...</p>
    </div>
    
    <div id="local-result" style="display: none; margin-top: 20px;">
        <div class="stats">
            <div class="stat-item">
                <strong>Sequences</strong>
                <span id="local-sequences">-</span>
            </div>
            <div class="stat-item">
                <strong>Total Bases</strong>
                <span id="local-bases">-</span>
            </div>
            <div class="stat-item">
                <strong>Shards Created</strong>
                <span id="local-shards">-</span>
            </div>
        </div>
        <p style="margin-top: 15px;">Output: <code id="local-output">-</code></p>
    </div>
</div>

<div class="card">
    <h3>Download Organelle Sequences</h3>
    <p>Download pre-configured organelle sequences from HuggingFace Hub.</p>
    
    <form id="organelle-ingest-form">
        <div class="form-group">
            <label for="org-output">Output Directory</label>
            <input type="text" id="org-output" name="output" value="/data/parquet/organelle" placeholder="/data/parquet/organelle">
        </div>
        
        <div class="form-group">
            <label for="org-chunk-size">Chunk Size</label>
            <input type="number" id="org-chunk-size" name="chunk_size" value="50000" min="1000">
        </div>
        
        <div class="form-group">
            <label for="org-compression">Compression</label>
            <select id="org-compression" name="compression">
                <option value="snappy" selected>Snappy</option>
                <option value="gzip">Gzip</option>
                <option value="zstd">Zstd</option>
                <option value="none">None</option>
            </select>
        </div>
        
        <button type="submit">Download and Ingest</button>
    </form>
    
    <div id="org-loading" class="loading">
        <div class="spinner"></div>
        <p>Downloading and processing sequences...</p>
    </div>
    
    <div id="org-result" style="display: none; margin-top: 20px;">
        <div class="stats">
            <div class="stat-item">
                <strong>Sequences</strong>
                <span id="org-sequences">-</span>
            </div>
            <div class="stat-item">
                <strong>Total Bases</strong>
                <span id="org-bases">-</span>
            </div>
            <div class="stat-item">
                <strong>Shards Created</strong>
                <span id="org-shards">-</span>
            </div>
        </div>
        <p style="margin-top: 15px;">Output: <code id="org-output-path">-</code></p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Handle local file upload
    document.getElementById('local-ingest-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const loadingEl = document.getElementById('local-loading');
        const resultEl = document.getElementById('local-result');
        
        // Show loading
        loadingEl.classList.add('active');
        resultEl.style.display = 'none';
        e.target.querySelector('button').disabled = true;
        
        try {
            const response = await fetch('/api/ingest/local', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // Show results
                document.getElementById('local-sequences').textContent = data.stats.total_sequences.toLocaleString();
                document.getElementById('local-bases').textContent = data.stats.total_bases.toLocaleString();
                document.getElementById('local-shards').textContent = data.stats.total_shards;
                document.getElementById('local-output').textContent = data.stats.output_path;
                
                resultEl.style.display = 'block';
                showAlert('Ingestion completed successfully!', 'success');
            } else {
                showAlert('Error: ' + data.message, 'error');
            }
        } catch (error) {
            showAlert('Request failed: ' + error.message, 'error');
        } finally {
            loadingEl.classList.remove('active');
            e.target.querySelector('button').disabled = false;
        }
    });
    
    // Handle organelle ingestion
    document.getElementById('organelle-ingest-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        const loadingEl = document.getElementById('org-loading');
        const resultEl = document.getElementById('org-result');
        
        // Show loading
        loadingEl.classList.add('active');
        resultEl.style.display = 'none';
        e.target.querySelector('button').disabled = true;
        
        try {
            const response = await fetch('/api/ingest/organelle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            
            if (responseData.status === 'success') {
                // Show results
                document.getElementById('org-sequences').textContent = responseData.stats.total_sequences.toLocaleString();
                document.getElementById('org-bases').textContent = responseData.stats.total_bases.toLocaleString();
                document.getElementById('org-shards').textContent = responseData.stats.total_shards;
                document.getElementById('org-output-path').textContent = responseData.stats.output_path;
                
                resultEl.style.display = 'block';
                showAlert('Ingestion completed successfully!', 'success');
            } else {
                showAlert('Error: ' + responseData.message, 'error');
            }
        } catch (error) {
            showAlert('Request failed: ' + error.message, 'error');
        } finally {
            loadingEl.classList.remove('active');
            e.target.querySelector('button').disabled = false;
        }
    });
</script>
{% endblock %}
